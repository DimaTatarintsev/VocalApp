import tkinter as tk
from tkinter import ttk, messagebox
import pyaudio
import numpy as np
import threading
import queue
import time
from collections import deque
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg
import matplotlib.animation as animation

class PitchDetector:
    def __init__(self):
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏–æ
        self.CHUNK = 1024 * 4
        self.FORMAT = pyaudio.paInt16
        self.CHANNELS = 1
        self.RATE = 44100
        self.SILENCE_THRESHOLD = 500
        
        # –ù–æ—Ç–Ω—ã–µ —á–∞—Å—Ç–æ—Ç—ã (A4 = 440 Hz)
        self.NOTES = {
            'C': [16.35, 32.70, 65.41, 130.81, 261.63, 523.25, 1046.50, 2093.00, 4186.01],
            'C#': [17.32, 34.65, 69.30, 138.59, 277.18, 554.37, 1108.73, 2217.46, 4434.92],
            'D': [18.35, 36.71, 73.42, 146.83, 293.66, 587.33, 1174.66, 2349.32, 4698.63],
            'D#': [19.45, 38.89, 77.78, 155.56, 311.13, 622.25, 1244.51, 2489.02, 4978.03],
            'E': [20.60, 41.20, 82.41, 164.81, 329.63, 659.25, 1318.51, 2637.02, 5274.04],
            'F': [21.83, 43.65, 87.31, 174.61, 349.23, 698.46, 1396.91, 2793.83, 5587.65],
            'F#': [23.12, 46.25, 92.50, 185.00, 369.99, 739.99, 1479.98, 2959.96, 5919.91],
            'G': [24.50, 49.00, 98.00, 196.00, 392.00, 783.99, 1567.98, 3135.96, 6271.93],
            'G#': [25.96, 51.91, 103.83, 207.65, 415.30, 830.61, 1661.22, 3322.44, 6644.88],
            'A': [27.50, 55.00, 110.00, 220.00, 440.00, 880.00, 1760.00, 3520.00, 7040.00],
            'A#': [29.14, 58.27, 116.54, 233.08, 466.16, 932.33, 1864.66, 3729.31, 7458.62],
            'B': [30.87, 61.74, 123.47, 246.94, 493.88, 987.77, 1975.53, 3951.07, 7902.13]
        }
        
        self.audio = pyaudio.PyAudio()
        self.stream = None
        self.is_listening = False
        self.audio_queue = queue.Queue()
        self.current_note = ""
        self.current_frequency = 0
        self.confidence = 0
        self.volume = 0
        
    def start_listening(self):
        """–ù–∞—á–∞—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞"""
        try:
            self.stream = self.audio.open(
                format=self.FORMAT,
                channels=self.CHANNELS,
                rate=self.RATE,
                input=True,
                frames_per_buffer=self.CHUNK,
                stream_callback=self.audio_callback
            )
            self.is_listening = True
            self.stream.start_stream()
            return True
        except Exception as e:
            print(f"Audio error: {e}")
            return False
    
    def stop_listening(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ"""
        self.is_listening = False
        if self.stream:
            self.stream.stop_stream()
            self.stream.close()
    
    def audio_callback(self, in_data, frame_count, time_info, status):
        """Callback –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö"""
        if self.is_listening:
            self.audio_queue.put(in_data)
        return (in_data, pyaudio.paContinue)
    
    def find_closest_note(self, frequency):
        """–ù–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à—É—é –Ω–æ—Ç—É –∫ –∑–∞–¥–∞–Ω–Ω–æ–π —á–∞—Å—Ç–æ—Ç–µ"""
        if frequency == 0:
            return "", 0
        
        min_diff = float('inf')
        closest_note = ""
        closest_octave = 0
        
        for note, freqs in self.NOTES.items():
            for octave, freq in enumerate(freqs):
                diff = abs(frequency - freq)
                if diff < min_diff:
                    min_diff = diff
                    closest_note = note
                    closest_octave = octave
        
        # –†–∞—Å—á–µ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (—á–µ–º –±–ª–∏–∂–µ –∫ —Ç–æ—á–Ω–æ–π –Ω–æ—Ç–µ, —Ç–µ–º –≤—ã—à–µ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å)
        confidence = max(0, 100 - (min_diff / frequency * 100))
        return f"{closest_note}{closest_octave}", confidence
    
    def calculate_frequency(self, data):
        """–í—ã—á–∏—Å–ª–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç–æ—Ç—É –∏–∑ –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö"""
        # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ numpy array
        audio_data = np.frombuffer(data, dtype=np.int16)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        self.volume = np.sqrt(np.mean(audio_data**2))
        if self.volume < self.SILENCE_THRESHOLD:
            return 0
        
        # –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–∫–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
        window = np.hanning(len(audio_data))
        audio_data = audio_data * window
        
        # –ë–ü–§
        fft = np.fft.rfft(audio_data)
        frequencies = np.fft.rfftfreq(len(audio_data), 1.0/self.RATE)
        
        # –ù–∞—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–∏–∫–∞
        magnitude = np.abs(fft)
        peak_index = np.argmax(magnitude[1:]) + 1  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º DC –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
        
        if peak_index < len(frequencies):
            return frequencies[peak_index]
        return 0

class RealTimePitchApp:
    def __init__(self, root):
        self.root = root
        self.root.title("Nail the Pitch - –¢—Ä–µ–Ω–µ—Ä –Ω–æ—Ç")
        self.root.geometry("1000x800")
        self.root.configure(bg='#2c3e50')
        
        self.detector = PitchDetector()
        self.is_running = False
        self.history = deque(maxlen=50)  # –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ—Ç
        self.setup_ui()
        
    def setup_ui(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        # –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        main_frame = ttk.Frame(self.root)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)
        
        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        title_label = tk.Label(main_frame, text="üéµ Nail the Pitch - –¢—Ä–µ–Ω–µ—Ä –Ω–æ—Ç", 
                              font=('Arial', 24, 'bold'), 
                              fg='#ecf0f1', bg='#2c3e50')
        title_label.pack(pady=10)
        
        # –§—Ä–µ–π–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        control_frame = ttk.Frame(main_frame)
        control_frame.pack(fill=tk.X, pady=10)
        
        # –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        self.start_button = ttk.Button(control_frame, text="üé§ –ù–∞—á–∞—Ç—å –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ", 
                                      command=self.start_detection)
        self.start_button.pack(side=tk.LEFT, padx=5)
        
        self.stop_button = ttk.Button(control_frame, text="‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", 
                                     command=self.stop_detection, state='disabled')
        self.stop_button.pack(side=tk.LEFT, padx=5)
        
        # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
        content_frame = ttk.Frame(main_frame)
        content_frame.pack(fill=tk.BOTH, expand=True, pady=10)
        
        # –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–æ—Ç—ã
        left_panel = ttk.LabelFrame(content_frame, text="–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–∞—è –Ω–æ—Ç–∞")
        left_panel.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 10))
        
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –Ω–æ—Ç—ã
        self.note_display = tk.Label(left_panel, text="--", 
                                    font=('Arial', 72, 'bold'),
                                    fg='#e74c3c', bg='#34495e')
        self.note_display.pack(pady=20, fill=tk.BOTH, expand=True)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–æ—Ç–µ
        info_frame = ttk.Frame(left_panel)
        info_frame.pack(fill=tk.X, pady=10)
        
        self.freq_label = tk.Label(info_frame, text="–ß–∞—Å—Ç–æ—Ç–∞: -- Hz", 
                                  font=('Arial', 14), fg='#bdc3c7', bg='#34495e')
        self.freq_label.pack(anchor=tk.W)
        
        self.confidence_label = tk.Label(info_frame, text="–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: --%", 
                                        font=('Arial', 14), fg='#bdc3c7', bg='#34495e')
        self.confidence_label.pack(anchor=tk.W)
        
        self.volume_label = tk.Label(info_frame, text="–ì—Ä–æ–º–∫–æ—Å—Ç—å: --", 
                                    font=('Arial', 14), fg='#bdc3c7', bg='#34495e')
        self.volume_label.pack(anchor=tk.W)
        
        # –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –≥—Ä–∞—Ñ–∏–∫ –∏ –∏—Å—Ç–æ—Ä–∏—è
        right_panel = ttk.Frame(content_frame)
        right_panel.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True)
        
        # –ì—Ä–∞—Ñ–∏–∫ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        graph_frame = ttk.LabelFrame(right_panel, text="–ì—Ä–∞—Ñ–∏–∫ —á–∞—Å—Ç–æ—Ç")
        graph_frame.pack(fill=tk.BOTH, expand=True, pady=(0, 10))
        
        self.setup_plot(graph_frame)
        
        # –ò—Å—Ç–æ—Ä–∏—è –Ω–æ—Ç
        history_frame = ttk.LabelFrame(right_panel, text="–ò—Å—Ç–æ—Ä–∏—è –Ω–æ—Ç")
        history_frame.pack(fill=tk.BOTH, expand=True)
        
        self.history_text = tk.Text(history_frame, height=8, font=('Arial', 12),
                                   bg='#2c3e50', fg='#ecf0f1', insertbackground='white')
        self.history_text.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)
        
        # –°—Ç–∞—Ç—É—Å –±–∞—Ä
        self.status_var = tk.StringVar()
        self.status_var.set("–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ")
        status_bar = tk.Label(main_frame, textvariable=self.status_var, 
                             relief=tk.SUNKEN, anchor=tk.W,
                             font=('Arial', 10), fg='#95a5a6', bg='#34495e')
        status_bar.pack(fill=tk.X, side=tk.BOTTOM)
        
    def setup_plot(self, parent):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞"""
        self.fig, self.ax = plt.subplots(figsize=(6, 4), facecolor='#2c3e50')
        self.canvas = FigureCanvasTkAgg(self.fig, parent)
        self.canvas.get_tk_widget().pack(fill=tk.BOTH, expand=True)
        
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –≤–∏–¥–∞ –≥—Ä–∞—Ñ–∏–∫–∞
        self.ax.set_facecolor('#34495e')
        self.ax.tick_params(colors='white')
        self.ax.set_xlabel('–í—Ä–µ–º—è (—Å)', color='white')
        self.ax.set_ylabel('–ß–∞—Å—Ç–æ—Ç–∞ (Hz)', color='white')
        self.ax.set_title('–ß–∞—Å—Ç–æ—Ç–Ω—ã–π —Å–ø–µ–∫—Ç—Ä', color='white')
        
        self.line, = self.ax.plot([], [], 'c-', linewidth=2)
        self.ax.set_xlim(0, 5)
        self.ax.set_ylim(0, 1000)
        
    def start_detection(self):
        """–ó–∞–ø—É—Å–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–æ—Ç"""
        if self.detector.start_listening():
            self.is_running = True
            self.start_button.config(state='disabled')
            self.stop_button.config(state='normal')
            self.status_var.set("–ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ... –ì–æ–≤–æ—Ä–∏—Ç–µ –∏–ª–∏ –ø–æ–π—Ç–µ –≤ –º–∏–∫—Ä–æ—Ñ–æ–Ω")
            self.start_animation()
        else:
            messagebox.showerror("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É")
    
    def stop_detection(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –Ω–æ—Ç"""
        self.is_running = False
        self.detector.stop_listening()
        self.start_button.config(state='normal')
        self.stop_button.config(state='disabled')
        self.status_var.set("–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
        self.note_display.config(text="--", fg='#7f8c8d')
        self.freq_label.config(text="–ß–∞—Å—Ç–æ—Ç–∞: -- Hz")
        self.confidence_label.config(text="–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: --%")
        self.volume_label.config(text="–ì—Ä–æ–º–∫–æ—Å—Ç—å: --")
    
    def start_animation(self):
        """–ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        if hasattr(self, 'anim'):
            self.anim.event_source.stop()
        
        self.anim = animation.FuncAnimation(
            self.fig, self.update_plot, interval=50, blit=False, cache_frame_data=False
        )
        self.canvas.draw()
        self.process_audio()
    
    def process_audio(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
        def audio_processor():
            while self.is_running:
                try:
                    # –ü–æ–ª—É—á–µ–Ω–∏–µ –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—á–µ—Ä–µ–¥–∏
                    data = self.detector.audio_queue.get(timeout=0.1)
                    frequency = self.detector.calculate_frequency(data)
                    
                    if frequency > 0:
                        note, confidence = self.detector.find_closest_note(frequency)
                        self.detector.current_note = note
                        self.detector.current_frequency = frequency
                        self.detector.confidence = confidence
                        
                        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                        timestamp = time.strftime("%H:%M:%S")
                        self.history.appendleft(f"{timestamp} - {note} ({frequency:.1f} Hz)")
                        
                        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
                        self.root.after(0, self.update_note_display)
                        
                except queue.Empty:
                    continue
                except Exception as e:
                    print(f"Audio processing error: {e}")
        
        # –ó–∞–ø—É—Å–∫ –ø–æ—Ç–æ–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ
        self.audio_thread = threading.Thread(target=audio_processor, daemon=True)
        self.audio_thread.start()
    
    def update_note_display(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ—Ç—ã"""
        note = self.detector.current_note
        freq = self.detector.current_frequency
        conf = self.detector.confidence
        vol = self.detector.volume
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–æ—Ç—ã
        self.note_display.config(text=note, fg='#e74c3c')
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        self.freq_label.config(text=f"–ß–∞—Å—Ç–æ—Ç–∞: {freq:.1f} Hz")
        self.confidence_label.config(text=f"–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {conf:.1f}%")
        self.volume_label.config(text=f"–ì—Ä–æ–º–∫–æ—Å—Ç—å: {vol:.0f}")
        
        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏
        self.update_history()
        
        # –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
        if conf > 90:
            self.note_display.config(fg='#2ecc71')  # –ó–µ–ª–µ–Ω—ã–π - –≤—ã—Å–æ–∫–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
        elif conf > 70:
            self.note_display.config(fg='#f39c12')  # –û—Ä–∞–Ω–∂–µ–≤—ã–π - —Å—Ä–µ–¥–Ω—è—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
    
    def update_history(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –Ω–æ—Ç"""
        self.history_text.delete(1.0, tk.END)
        for i, entry in enumerate(self.history):
            if i < 10:  # –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∑–∞–ø–∏—Å–µ–π
                self.history_text.insert(tk.END, entry + '\n')
    
    def update_plot(self, frame):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞"""
        if self.detector.current_frequency > 0:
            # –ü—Ä–æ—Å—Ç–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            x_data = list(self.line.get_xdata())
            y_data = list(self.line.get_ydata())
            
            x_data.append(frame / 20)
            y_data.append(self.detector.current_frequency)
            
            # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö
            if len(x_data) > 100:
                x_data = x_data[-100:]
                y_data = y_data[-100:]
            
            self.line.set_data(x_data, y_data)
            self.ax.set_xlim(max(0, x_data[0]), x_data[-1] + 0.1)
            self.ax.set_ylim(0, max(1000, max(y_data) * 1.1))
        
        return self.line,

    def on_closing(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"""
        self.stop_detection()
        self.root.destroy()

def main():
    root = tk.Tk()
    app = RealTimePitchApp(root)
    root.protocol("WM_DELETE_WINDOW", app.on_closing)
    
    # –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–∫–Ω–∞
    root.update_idletasks()
    x = (root.winfo_screenwidth() // 2) - (root.winfo_width() // 2)
    y = (root.winfo_screenheight() // 2) - (root.winfo_height() // 2)
    root.geometry(f"+{x}+{y}")
    
    root.mainloop()

if __name__ == "__main__":
    main()
